# سياسة إنشاء المستخدمين في منصة راصد

## نظرة عامة

هذا المستند يوضح السياسة الكاملة وآلية إنشاء المستخدمين في النظام حسب الدور.

---

## 1. السوبر أدمن (SuperAdmin)

### من يمكنه الإنشاء:
- **السوبر أدمن** فقط يمكنه إنشاء مستخدمين من جميع الأدوار

### الأدوار التي يمكن إنشاؤها:
- ✅ **SuperAdmin** (مدير النظام)
- ✅ **Admin** (مدير)
- ✅ **EnergyAuthority** (سلطة الطاقة)
- ✅ **CompanyOwner** (مشغل)
- ✅ **Employee** (موظف)
- ✅ **Technician** (فني)

---

### أ) إنشاء SuperAdmin / Admin / EnergyAuthority / CompanyOwner

#### البيانات المطلوبة:
| الحقل | مطلوب | ملاحظات |
|------|-------|---------|
| `name` | ✅ نعم | الاسم بالعربية |
| `name_en` | ✅ نعم | الاسم بالإنجليزية |
| `phone` | ✅ نعم | رقم الجوال (059xxxxxxx أو 056xxxxxxx) |
| `email` | ✅ نعم | البريد الإلكتروني |
| `role` | ✅ نعم | الدور (SuperAdmin, Admin, EnergyAuthority, CompanyOwner) |
| `username` | ❌ لا | **يتم توليده تلقائياً** |
| `password` | ❌ لا | **يتم توليده تلقائياً** |
| `operator_id` | ⚠️ شرطي | مطلوب فقط عند إنشاء **CompanyOwner** |

#### توليد Username تلقائياً:
```
الصيغة: [prefix]_[first_char][last_name]

أمثلة:
- SuperAdmin: sp_tboawab (من "Taha Boawab")
- Admin: ad_ahmad (من "Ahmad")
- EnergyAuthority: ea_sultan (من "Sultan")
- CompanyOwner: ad_mohammed (من "Mohammed")
```

**آلية التوليد:**
1. استخدام `name_en` إذا كان موجوداً، وإلا `name`
2. تقسيم الاسم إلى كلمات
3. أخذ الحرف الأول من الاسم الأول
4. أخذ اسم العائلة (آخر كلمة)
5. إضافة البادئة حسب الدور:
   - `sp_` للـ SuperAdmin
   - `ad_` للـ Admin
   - `ea_` للـ EnergyAuthority
   - `ad_` للـ CompanyOwner (نفس صيغة Admin)
6. إذا كان username موجود، يضاف رقم: `sp_tboawab1`, `sp_tboawab2`, إلخ

#### توليد Password تلقائياً:
- **8 أحرف عشوائية** (أرقام وحروف فقط)
- يتم حفظه في `password_plain` لإرساله عبر SMS

#### إرسال SMS:
- ✅ **يتم إرسال SMS تلقائياً** إلى رقم الجوال يحتوي على:
  - رسالة ترحيبية
  - الدور
  - اسم المستخدم
  - كلمة المرور
  - رابط الدخول

---

### ب) إنشاء Employee / Technician

#### البيانات المطلوبة:
| الحقل | مطلوب | ملاحظات |
|------|-------|---------|
| `name` | ✅ نعم | الاسم بالعربية |
| `name_en` | ❌ لا | اختياري |
| `phone` | ❌ لا | اختياري |
| `email` | ❌ لا | **يتم توليده تلقائياً** إذا لم يُدخل |
| `role` | ✅ نعم | Employee أو Technician |
| `username` | ❌ لا | **يتم توليده تلقائياً** |
| `password` | ❌ لا | **يتم توليده تلقائياً** |
| `operator_id` | ✅ نعم | **مطلوب** - المشغل الذي سيرتبط به الموظف/الفني |

#### توليد Username تلقائياً:
```
الصيغة: [operator_username]_[employee_name]

مثال:
- إذا كان username المشغل: "mohammed_operator"
- واسم الموظف: "أحمد محمد"
- النتيجة: "mohammed_operator_ahmad_mohammed"
```

**آلية التوليد:**
1. أخذ `username` المشغل (owner)
2. تنظيف اسم الموظف (إزالة المسافات والأحرف الخاصة)
3. تحويل إلى lowercase
4. دمج: `operator_username_employee_name`
5. إذا كان موجود، يضاف رقم: `mohammed_operator_ahmad1`, إلخ

#### توليد Password تلقائياً:
- **8 أحرف عشوائية** (أرقام وحروف فقط)

#### توليد Email تلقائياً:
- إذا لم يُدخل email، يتم توليده: `[username]@rased.local`
- إذا كان موجود، يضاف رقم: `username1@rased.local`, إلخ

#### ربط بالمشغل:
- ✅ يتم ربط الموظف/الفني تلقائياً بالمشغل المحدد في `operator_id`
- ⚠️ **لا يتم تفعيل المشغل تلقائياً** (يجب أن يكون معتمد مسبقاً)

#### إرسال SMS:
- ✅ يتم إرسال SMS **فقط إذا كان هناك رقم جوال**

---

## 2. سلطة الطاقة (EnergyAuthority)

### من يمكنه الإنشاء:
- **سلطة الطاقة** يمكنه إنشاء مستخدمين تحت سلطته

### الأدوار التي يمكن إنشاؤها:
- ✅ **Admin** (مدير)
- ✅ **EnergyAuthority** (سلطة الطاقة)
- ✅ **CompanyOwner** (مشغل)
- ✅ **Employee** (موظف)
- ✅ **Technician** (فني)
- ❌ **SuperAdmin** (غير مسموح)

---

### أ) إنشاء Admin / EnergyAuthority / CompanyOwner

#### البيانات المطلوبة:
| الحقل | مطلوب | ملاحظات |
|------|-------|---------|
| `name` | ✅ نعم | الاسم بالعربية |
| `name_en` | ✅ نعم | الاسم بالإنجليزية |
| `phone` | ✅ نعم | رقم الجوال |
| `email` | ✅ نعم | البريد الإلكتروني |
| `role` | ✅ نعم | Admin, EnergyAuthority, أو CompanyOwner |
| `username` | ❌ لا | **يتم توليده تلقائياً** |
| `password` | ❌ لا | **يتم توليده تلقائياً** |
| `operator_id` | ⚠️ شرطي | مطلوب فقط عند إنشاء **CompanyOwner** |

#### توليد Username تلقائياً:
```
الصيغة: [prefix]_[first_char][last_name]

أمثلة:
- Admin: ad_ahmad
- EnergyAuthority: ea_sultan
- CompanyOwner: ad_mohammed
```

**نفس آلية السوبر أدمن**

#### توليد Password تلقائياً:
- **8 أحرف عشوائية**

#### إرسال SMS:
- ✅ **يتم إرسال SMS تلقائياً**

---

### ب) إنشاء Employee / Technician

#### نفس آلية السوبر أدمن:
- نفس البيانات المطلوبة
- نفس آلية توليد username و password
- نفس آلية ربط بالمشغل
- نفس آلية إرسال SMS

---

## 3. المشغل (CompanyOwner)

### من يمكنه الإنشاء:
- **المشغل** يمكنه إنشاء موظفين وفنيين فقط تحت مشغله

### الأدوار التي يمكن إنشاؤها:
- ✅ **Employee** (موظف)
- ✅ **Technician** (فني)
- ❌ جميع الأدوار الأخرى (غير مسموح)

---

### إنشاء Employee / Technician

#### البيانات المطلوبة:
| الحقل | مطلوب | ملاحظات |
|------|-------|---------|
| `name` | ✅ نعم | الاسم بالعربية |
| `name_en` | ❌ لا | اختياري |
| `phone` | ❌ لا | اختياري |
| `email` | ❌ لا | **يتم توليده تلقائياً** |
| `role` | ✅ نعم | Employee أو Technician |
| `username` | ❌ لا | **يتم توليده تلقائياً** |
| `password` | ❌ لا | **يتم توليده تلقائياً** |
| `operator_id` | ❌ لا | **يتم ربطه تلقائياً بمشغل المستخدم الحالي** |

#### توليد Username تلقائياً:
```
الصيغة: [operator_username]_[employee_name]

مثال:
- إذا كان username المشغل: "mohammed_operator"
- واسم الموظف: "أحمد محمد"
- النتيجة: "mohammed_operator_ahmad_mohammed"
```

**نفس آلية السوبر أدمن عند إنشاء موظف**

#### توليد Password تلقائياً:
- **8 أحرف عشوائية**

#### توليد Email تلقائياً:
- إذا لم يُدخل email، يتم توليده: `[username]@rased.local`

#### ربط بالمشغل:
- ✅ يتم ربط الموظف/الفني **تلقائياً** بمشغل المستخدم الحالي
- ⚠️ يجب أن يكون المشغل موجود ومرتبط بحساب المشغل

#### إرسال SMS:
- ✅ يتم إرسال SMS **فقط إذا كان هناك رقم جوال**

---

## 4. Admin (مدير)

### من يمكنه الإنشاء:
- **Admin** **لا يمكنه** إنشاء مستخدمين
- Admin لديه صلاحيات محدودة (عرض فقط)

---

## 5. Employee / Technician

### من يمكنه الإنشاء:
- **الموظفون والفنيون** **لا يمكنهم** إنشاء مستخدمين

---

## ملخص سريع

| الدور | يمكنه إنشاء | البيانات المطلوبة | Username | Password | SMS |
|------|------------|------------------|----------|----------|-----|
| **SuperAdmin** | جميع الأدوار | حسب الدور (انظر أعلاه) | تلقائي | تلقائي | ✅ |
| **EnergyAuthority** | Admin, EnergyAuthority, CompanyOwner, Employee, Technician | حسب الدور | تلقائي | تلقائي | ✅ |
| **CompanyOwner** | Employee, Technician فقط | الاسم فقط | تلقائي | تلقائي | ⚠️ إذا كان هناك رقم جوال |
| **Admin** | ❌ لا شيء | - | - | - | - |
| **Employee** | ❌ لا شيء | - | - | - | - |
| **Technician** | ❌ لا شيء | - | - | - | - |

---

## خطوات إنشاء المستخدم (آلية العمل)

### الخطوة 1: التحقق من الصلاحيات
- يتم التحقق من أن المستخدم الحالي لديه صلاحية إنشاء المستخدم المطلوب
- يتم التحقق من الدور المسموح

### الخطوة 2: الحصول على role_id
- يتم البحث عن `Role` في جدول `roles` باستخدام `findByName()`
- يتم ربط المستخدم بـ `role_id` و `role` (enum)

### الخطوة 3: ربط الموظف/الفني بالمشغل
- إذا كان الدور `Employee` أو `Technician`:
  - إذا كان المستخدم الحالي `CompanyOwner`: يتم ربطه تلقائياً بمشغله
  - إذا كان المستخدم الحالي `SuperAdmin` أو `EnergyAuthority`: يجب تحديد `operator_id`

### الخطوة 4: توليد Username و Password
- يتم توليدهما تلقائياً حسب الدور (انظر أعلاه)
- يتم التأكد من أن username فريد (مع مراعاة soft deletes)

### الخطوة 5: توليد Email
- إذا لم يُدخل email، يتم توليده: `[username]@rased.local`
- يتم التأكد من أن email فريد

### الخطوة 6: إنشاء المستخدم
- يتم إنشاء المستخدم في قاعدة البيانات
- يتم حفظ `password_plain` لإرساله عبر SMS

### الخطوة 7: ربط المستخدم بالمشغل
- إذا كان `Employee` أو `Technician`: يتم ربطه بالمشغل
- إذا كان `CompanyOwner` وتم تحديد `operator_id`: يتم ربطه بالمشغل وتفعيل المشغل إذا لم يكن معتمد

### الخطوة 8: إرسال SMS
- إذا كان هناك رقم جوال، يتم إرسال SMS تلقائياً يحتوي على:
  - رسالة ترحيبية
  - الدور
  - اسم المستخدم
  - كلمة المرور
  - رابط الدخول

### الخطوة 9: إنشاء الرسائل الافتراضية
- يتم إنشاء 3 رسائل ترحيبية للمستخدم الجديد:
  - رسالة تغيير الباسورد
  - رسالة ترحيب
  - رسالة معلومات مهمة

### الخطوة 10: إرسال إشعار للسوبر أدمن
- إذا لم يكن المستخدم الحالي `SuperAdmin`، يتم إرسال إشعار للسوبر أدمن

---

## أمثلة عملية

### مثال 1: السوبر أدمن ينشئ SuperAdmin جديد
```
المدخلات:
- name: "طه بوعواب"
- name_en: "Taha Boawab"
- phone: "0592632026"
- email: "taha@example.com"
- role: "super_admin"

النتيجة:
- username: "sp_tboawab" (أو sp_tboawab1 إذا كان موجود)
- password: "aB3xY9mK" (8 أحرف عشوائية)
- SMS: يتم إرسال رسالة تحتوي على البيانات والرابط
```

### مثال 2: المشغل ينشئ موظف جديد
```
المدخلات:
- name: "أحمد محمد"
- role: "employee"
- (username و password تلقائي)

النتيجة:
- username: "mohammed_operator_ahmad_mohammed" (إذا كان username المشغل هو "mohammed_operator")
- password: "xY9mKaB3" (8 أحرف عشوائية)
- email: "mohammed_operator_ahmad_mohammed@rased.local"
- SMS: يتم إرسال رسالة إذا كان هناك رقم جوال
```

### مثال 3: سلطة الطاقة تنشئ Admin جديد
```
المدخلات:
- name: "أحمد"
- name_en: "Ahmad"
- phone: "0591234567"
- email: "ahmad@example.com"
- role: "admin"

النتيجة:
- username: "ad_ahmad" (أو ad_ahmad1 إذا كان موجود)
- password: "mK9xYaB3" (8 أحرف عشوائية)
- SMS: يتم إرسال رسالة تحتوي على البيانات والرابط
```

---

## ملاحظات مهمة

1. **Username فريد**: يتم التأكد من أن username فريد (مع مراعاة soft deletes)
2. **Email فريد**: يتم التأكد من أن email فريد (مع مراعاة soft deletes)
3. **Password آمن**: يتم توليد password عشوائي 8 أحرف (أرقام وحروف فقط)
4. **SMS تلقائي**: يتم إرسال SMS تلقائياً عند إنشاء مستخدم جديد (إذا كان هناك رقم جوال)
5. **ربط تلقائي**: يتم ربط الموظف/الفني تلقائياً بالمشغل
6. **تفعيل المشغل**: عند إنشاء CompanyOwner وربطه بمشغل، يتم تفعيل المشغل تلقائياً إذا لم يكن معتمد

---

## الملفات ذات الصلة

- `app/Http/Controllers/Admin/UserController.php` - كنترولر إنشاء المستخدمين
- `app/Http/Requests/Admin/StoreUserRequest.php` - قواعد التحقق من البيانات
- `app/Policies/UserPolicy.php` - سياسة الصلاحيات
- `app/Models/User.php` - نموذج المستخدم

---

**آخر تحديث:** 2025-01-09



